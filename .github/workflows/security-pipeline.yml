name: ğŸ›¡ï¸ Pipeline de SeguranÃ§a DevSec

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: write # necessÃ¡rio para publicar no GitHub Pages

jobs:
  security-pipeline:
    runs-on: ubuntu-latest
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      CODEQL_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: ğŸ”¹ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”¹ Configurar Node e Python
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ”¹ Instalar dependÃªncias Python
        run: |
          python -m pip install --upgrade pip
          pip install pytest requests flask

      - name: ğŸ”¹ Instalar dependÃªncias Node
        run: |
          npm install -g snyk
          npm install

      - name: ğŸ”¹ Autenticar no GHCR (evitar login denied)
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u $ --password-stdin || echo "âš ï¸ Login GHCR falhou (pode ser ignorado)"

      - name: ğŸ”¹ Criar rede Docker segura
        run: |
          docker network create zapnet || true

      - name: ğŸ§ª Executar Testes UnitÃ¡rios (Pytest)
        run: |
          pytest -v || { echo "âŒ Testes falharam!"; exit 1; }

      - name: ğŸ›¡ï¸ Snyk SAST Scan
        run: |
          snyk auth $SNYK_TOKEN || { echo "âš ï¸ Erro ao autenticar no Snyk"; exit 1; }
          snyk test --severity-threshold=medium || { echo "âŒ Vulnerabilidades crÃ­ticas detectadas pelo Snyk"; exit 1; }

      - name: ğŸ§± Build Docker Image do App
        run: |
          docker build -t app-security:latest . --network zapnet || { echo "âŒ Falha ao construir imagem"; exit 1; }

      - name: ğŸš€ Rodar Container TemporÃ¡rio do App
        run: |
          docker run -d --rm --network zapnet --name app -p 5000:5000 app-security:latest || exit 1
          echo "â³ Aguardando app iniciar..."
          sleep 10

      - name: ğŸ” ZAP DAST Scan (usando GHCR)
        run: |
          mkdir -p reports
          docker pull ghcr.io/zaproxy/zaproxy:stable || { echo "âš ï¸ Falha ao puxar imagem ZAP"; exit 1; }
          docker run --rm --network zapnet \
            -v $(pwd)/reports:/zap/wrk/:rw \
            ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t http://app:5000 \
            -r zap_report.html || echo "âš ï¸ ZAP retornou alertas (nÃ£o crÃ­tico)"

      - name: ğŸ§  CodeQL - Inicializar
        uses: github/codeql-action/init@v3
        with:
          languages: python, javascript

      - name: ğŸ§  CodeQL - Executar AnÃ¡lise
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

      - name: ğŸ“¤ Publicar RelatÃ³rios como artefato
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: relatorios-seguranca
          path: |
            reports/zap_report.html
            test-results/

      - name: ğŸ“¤ Preparar relatÃ³rio para o GitHub Pages
        if: always()
        run: |
          mkdir -p ./public
          cp reports/zap_report.html ./public/index.html || echo "<h1>Nenhum relatÃ³rio ZAP encontrado</h1>" > ./public/index.html

      - name: ğŸŒ Publicar no GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public

      - name: ğŸ§¹ Encerrar Containers
        if: always()
        run: |
          docker stop app || true
          docker network rm zapnet || true
